name: Zero-Cost TikTok Bot

# Ejecuta cada 6 horas (4 veces al día) - Gratis en repos públicos
on:
  schedule:
    - cron: '0 6,12,18,0 * * *'  # 06:00, 12:00, 18:00, 00:00 UTC
  workflow_dispatch:  # Permite ejecución manual

# Evitar ejecuciones concurrentes
concurrency:
  group: tiktok-bot
  cancel-in-progress: true

jobs:
  run-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        sparse-checkout: |
          backend
          video
        sparse-checkout-cone-mode: false

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: video/package-lock.json

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
        cache-dependency-path: backend/requirements.txt

    # Instalar dependencias en paralelo para ahorrar tiempo
    - name: Install dependencies (parallel)
      run: |
        # Iniciar ambas instalaciones en background
        (cd video && npm ci) &
        pip install --no-cache-dir -r backend/requirements.txt &
        # Esperar a que ambas terminen
        wait
        echo "✅ Todas las dependencias instaladas"

    - name: Run Automation
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        GOOGLE_AI_API_KEY: ${{ secrets.GOOGLE_AI_API_KEY }}
        HUGGINGFACE_API_KEY: ${{ secrets.HUGGINGFACE_API_KEY }}
        HUGGINGFACE_MODEL: ${{ secrets.HUGGINGFACE_MODEL }}
        AMAZON_PARTNER_TAG: ${{ secrets.AMAZON_PARTNER_TAG }}
        TIKTOK_COOKIES_JSON: ${{ secrets.TIKTOK_COOKIES_JSON }}
        # Runway ML API para videos AI animados
        RUNWAY_API_KEY: ${{ secrets.RUNWAY_API_KEY }}
        ENABLE_RUNWAY: ${{ secrets.ENABLE_RUNWAY || 'false' }}
        CI: true
      run: |
        python backend/main.py

    # Log del resultado para debugging
    - name: Summary
      if: always()
      run: |
        echo "### TikTok Bot Run Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Run ID**: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Triggered by**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Timestamp**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
