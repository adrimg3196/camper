name: Zero-Cost TikTok Bot

# Ejecuta cada 6 horas (4 veces al día) - Gratis en repos públicos
on:
  schedule:
    - cron: '0 6,12,18,0 * * *'  # 06:00, 12:00, 18:00, 00:00 UTC
  workflow_dispatch:  # Permite ejecución manual

# Evitar ejecuciones concurrentes
concurrency:
  group: tiktok-bot
  cancel-in-progress: true

jobs:
  run-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        sparse-checkout: |
          backend
          video
        sparse-checkout-cone-mode: false

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: video/package-lock.json

    - name: Install Remotion dependencies
      run: npm ci
      working-directory: video

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
        cache-dependency-path: backend/requirements.txt

    - name: Install Python dependencies
      run: |
        pip install --no-cache-dir -r backend/requirements.txt

    - name: Run Automation
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        GOOGLE_AI_API_KEY: ${{ secrets.GOOGLE_AI_API_KEY }}
        HUGGINGFACE_API_KEY: ${{ secrets.HUGGINGFACE_API_KEY }}
        HUGGINGFACE_MODEL: ${{ secrets.HUGGINGFACE_MODEL }}
        AMAZON_PARTNER_TAG: ${{ secrets.AMAZON_PARTNER_TAG }}
        TIKTOK_COOKIES_JSON: ${{ secrets.TIKTOK_COOKIES_JSON }}
        CI: true
      run: |
        python backend/main.py
